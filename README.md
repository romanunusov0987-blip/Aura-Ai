# Aura-Ai

Aura — Telegram-бот онлайн-психолога с поддержкой медитаций, дневника и расширенной реферальной системы. Репозиторий содержит однофайловую версию бота и примеры backend-сервисов, которые обеспечивают платёжные и партнёрские сценарии.

## Структура проекта
- `Aura_Psycholog_bot.py` — главный сценарий бота. Он подключается к Telegram, настраивает окружение и описывает, как бот ведёт диалог с пользователем.
- `db.py` — помощник для работы с базой данных. Здесь создаётся подключение и описаны общие функции для сохранения данных.
- `.env` — базовый файл с переменными окружения (в репозитории хранится пример с пустыми значениями, заполните его перед запуском).
- `requirements.txt` — список библиотек, которые нужно установить перед запуском.
- `tariff_ru.md` — текстовое описание тарифов и услуг, доступных пользователю бота.
- `powershell_launch_guide.txt` — подробный пошаговый гайд по запуску проекта через Windows PowerShell.
- `admin_bot/` — модульный Telegram-бот с административной панелью и SQLite-хранилищем.
  - `__main__.py` — позволяет запускать бота через `python -m admin_bot`.
  - `__init__.py` — помечает папку как модуль.
  - `bot.py` — точка входа, собирает конфигурацию, настраивает логирование и запускает диспетчер.
  - `config.py` — читает переменные окружения и формирует настройки (токен, админы, пути).
  - `commands.py` — описывает команды `/stats`, `/users`, `/broadcast`, `/ban`, `/unban` и регистрацию пользователей.
  - `database.py` — слой доступа к SQLite (таблицы пользователей и журналов действий админов).
  - `logging_config.py` — общая конфигурация логирования в файл и консоль.
- `referral_app/` — отдельная папка с backend-сервисом FastAPI для реферальной программы.
  - `config.py` — хранит настройки бонусов, базовый URL для ссылок и лимиты по IP.
  - `database.py` — создаёт подключение к PostgreSQL и выдаёт сессии для работы с данными.
  - `models.py` — описывает таблицы в базе: пользователей, связи «кто кого пригласил» и журнал бонусов.
  - `schemas.py` — описывает структуру запросов и ответов API через Pydantic.
  - `crud.py` — бизнес-логика: генерация кодов, проверка регистраций, начисление и суммирование бонусных дней.
  - `main.py` — точка входа FastAPI, где собраны все REST-эндпоинты.
  - `__init__.py` — пустой файл, который показывает Python, что папка — модуль.
- `meditations/` — (необязательная) папка, которую можно создать для хранения собственных аудио-медитаций локально.

### Что делает каждый файл (простыми словами)
- **`Aura_Psycholog_bot.py`** — запускает бота и говорит ему, как отвечать людям.
- **`db.py`** — умеет подключаться к базе и сохранять туда информацию о пользователях и их действиях.
- **`admin_bot/bot.py`** — запускает административного бота и подключает все модули панели.
- **`admin_bot/commands.py`** — набор админ-команд (`/stats`, `/users`, `/broadcast`, `/ban`, `/unban`).
- **`admin_bot/database.py`** — слой доступа к SQLite для панели, хранит пользователей и действия админов.
- **`admin_bot/config.py`** — читает переменные окружения для административного бота.
- **`admin_bot/logging_config.py`** — единая настройка логирования для панели.
- **`referral_app/config.py`** — настройки реферальной программы: сколько дней даём в подарок и какие ограничения ставим.
- **`referral_app/database.py`** — создаёт соединение с базой данных для рефералок.
- **`referral_app/models.py`** — словарь таблиц в базе: кто пользователь, кто его пригласил, сколько бонусов начислено.
- **`referral_app/schemas.py`** — объясняет, какие поля ждём в запросах и что возвращаем в ответ.
- **`referral_app/crud.py`** — «мозг» сервиса: проверяет условия, считает бонусы и обновляет подписку.
- **`referral_app/main.py`** — связывает всё вместе и предоставляет HTTP-эндпоинты.
- **`README.md`** — это руководство по проекту: как устроено, как запускать и что где лежит.
- **`tariff_ru.md`** — текстовое описание тарифов, которое можно показать пользователю.
- **`requirements.txt`** — список зависимостей, который читают `pip` и другие менеджеры пакетов.
- **`.env`** — пример файла окружения с пустыми значениями, заполните его реальными токенами и ключами.
- **`powershell_launch_guide.txt`** — готовый набор PowerShell-команд для быстрого запуска всех сервисов.

### База данных и память диалогов бота
- Таблица `users` хранит Telegram ID, выбранную персону и базовую информацию о пользователе.
- Таблица `conversation_messages` сохраняет последние сообщения пользователя и ассистента для восстановления контекста общения (по умолчанию бот хранит 10 последних реплик, значение можно изменить переменной `CONVERSATION_HISTORY_LIMIT`).
- Таблицы `journal_entries`, `scale_results`, `event_logs`, `media_cache`, `referrals` и `user_bonuses` обслуживают дополнительные функции бота.

## Архитектура реферальной системы SaaS

### Обзор
Backend-реализация строится вокруг FastAPI и PostgreSQL. Сервис отвечает за генерацию реферальных ссылок, регистрацию по коду, учёт оплаченных подписок и автоматическое начисление бонусных дней пригласившему пользователю.

```
Клиент → FastAPI (referral_app/main.py) → SQLAlchemy (referral_app/database.py) → PostgreSQL
```

Основной сценарий:
1. Пользователь запрашивает уникальную ссылку (`POST /generate-referral-link`).
2. Приглашённый друг регистрируется по коду (`POST /register`).
3. Сервис фиксирует регистрацию, проверяет ограничение по IP и добавляет +3 дня пригласившему.
4. Когда приглашённый оплачивает подписку (`POST /subscribe`), рефереру начисляется ещё +7 дней.
5. Любой пользователь может посмотреть свою статистику (`GET /my-referrals`).

### Модели данных PostgreSQL
- `users`
  - `id` (UUID, PK)
  - `email` (уникальный), `name`, `password_hash`
  - `referral_code` (уникальный короткий код)
  - `referred_by_id` (FK → users.id) — кто пригласил
  - `subscription_end` (datetime) — окончание текущей подписки
  - `bonus_balance_days` (int) — суммарно начисленные бесплатные дни
  - `created_at` (datetime)
- `referrals`
  - `id` (UUID, PK)
  - `referrer_id`, `referee_id` (FK → users.id)
  - `registration_ip` (строка, используется для ограничения по IP)
  - `registered_at` (datetime)
  - `registration_bonus_days` (int, по умолчанию 3)
  - `subscription_bonus_awarded` (bool) и `subscription_bonus_days` (int, по умолчанию 0)
  - `subscription_awarded_at` (datetime) — когда бонус был начислен
- `bonus_events`
  - `id` (UUID, PK)
  - `user_id` (FK → users.id)
  - `referral_id` (FK → referrals.id)
  - `event_type` (`registration` или `subscription`)
  - `days_awarded`
  - `created_at`

Журнал `bonus_events` хранит полный след начислений и упрощает аудит или создание отчётов.

### Расчёт бонусных дней
- Регистрация по рефералу начисляет `settings.registration_bonus` (по умолчанию 3 дня) пригласившему.
- Первая оплата приглашённого пользователя начисляет `settings.subscription_bonus` (по умолчанию 7 дней).
- Функция `award_bonus_days` обновляет баланс пользователя и корректирует `subscription_end`: если подписка активна, дни прибавляются к текущей дате окончания, иначе отсчитываются от текущего момента.
- Ограничение по IP (`MAX_REGISTRATIONS_PER_IP`, по умолчанию 1) предотвращает злоупотребления множественными регистрациями.

### REST API
- `POST /generate-referral-link`
  - Тело: `{ "user_id": "UUID" }`
  - Результат: `{ "referral_code": "string", "referral_link": "https://..." }`
- `POST /register`
  - Тело: `{ "email": "user@example.com", "name": "Имя", "password": "***", "referral_code": "optional", "request_ip": "192.0.2.55" }`
  - Валидация: один IP не может зарегистрировать двух пользователей по одному и тому же коду.
  - Результат: `{ "user_id": "UUID", "awarded_days": 3, "referrer_id": "UUID" }`
- `POST /subscribe`
  - Тело: `{ "user_id": "UUID", "plan_days": 30 }`
  - Результат: `{ "user_id": "UUID", "subscription_end": "2024-05-01T12:00:00Z", "referrer_bonus_awarded": true, "referrer_id": "UUID" }`
- `GET /my-referrals`
  - Параметры: `?user_id=UUID`
  - Результат: список приглашённых и сводка начисленных дней.

### Запуск backend-сервиса рефералов
1. Настройте PostgreSQL и создайте базу данных `referral_db` (или укажите свою строку подключения в переменной `DATABASE_URL`).
2. Установите зависимости: `pip install -r requirements.txt`.
3. Запустите API: `uvicorn referral_app.main:app --reload`.
4. Документация будет доступна по адресу `http://127.0.0.1:8000/docs`.

## Быстрый старт Telegram-бота

> 🪟 Для пользователей Windows подготовлен файл `powershell_launch_guide.txt` — в нём собраны готовые PowerShell-команды для клонирования репозитория, настройки окружения и запуска всех сервисов.

1. Откройте и заполните файл `.env` (пример с пустыми значениями уже лежит в репозитории; параметр `CONVERSATION_HISTORY_LIMIT` регулирует глубину памяти диалога).
2. Установите зависимости: `pip install -r requirements.txt`.
3. Запустите бота: `python Aura_Psycholog_bot.py`.

## Быстрый цикл разработки и тестирования

### 1. Общая настройка окружения (один раз)
1. Создайте виртуальное окружение: `python -m venv .venv`.
2. Активируйте его.
   - macOS/Linux: `source .venv/bin/activate`
   - Windows PowerShell: `.\.venv\Scripts\Activate.ps1`
3. Обновите менеджер пакетов: `python -m pip install --upgrade pip`.
4. Установите зависимости проекта: `pip install -r requirements.txt`.

### 2. Быстрый перезапуск основного Telegram-бота
1. Перед стартом заполните `.env` (минимум `TELEGRAM_BOT_TOKEN`).
2. Запускайте бота командой `python Aura_Psycholog_bot.py`.
3. После правок прерывайте текущий процесс сочетанием `Ctrl+C` и немедленно перезапускайте ту же команду.
4. Чтобы ускорить отладку конкретных сценариев, временно снижайте глубину памяти: `CONVERSATION_HISTORY_LIMIT=2 python Aura_Psycholog_bot.py` (macOS/Linux) или `set CONVERSATION_HISTORY_LIMIT=2; python Aura_Psycholog_bot.py` (PowerShell).

### 3. Быстрая проверка административного бота
1. Убедитесь, что в `.env` заданы `ADMIN_TELEGRAM_BOT_TOKEN` и список `ADMIN_USER_IDS`.
2. Запускайте панель администрирования в том же окружении: `python -m admin_bot`.
3. Перезапускайте после правок так же, как основной бот (`Ctrl+C`, затем повторный запуск).

### 4. Горячий перезапуск реферального сервиса
1. Проверьте переменную `DATABASE_URL`: по умолчанию используется PostgreSQL (`postgresql+psycopg2://postgres:postgres@localhost:5432/referral_db`), но для локальных экспериментов можно временно указать SQLite (`sqlite:///referral_dev.db`).
2. Запускайте API с авто-перезагрузкой: `uvicorn referral_app.main:app --reload`.
3. После изменения моделей примените миграции (например, через Alembic) или удалите временную тестовую базу, чтобы пересоздать таблицы.
4. Документация в браузере доступна по адресу `http://127.0.0.1:8000/docs`.

## Административный бот с панелью управления
Базовый административный бот расположен в каталоге `admin_bot/` и использует ту же виртуальную среду, что и основной проект.

1. Убедитесь, что заданы переменные окружения:
   - `TELEGRAM_BOT_TOKEN` — токен основного бота.
   - `ADMIN_TELEGRAM_BOT_TOKEN` — отдельный токен администратора, полученный через BotFather.
   - `ADMIN_USER_IDS` — список ID админов через запятую.
   - `ADMIN_DATABASE_PATH` (необязательно) — путь к SQLite-файлу для панели, по умолчанию `admin_panel.db`.
   - `ADMIN_LOG_FILE` (необязательно) — путь к файлу логов, по умолчанию `admin_panel.log`.
2. Установите зависимости (если ещё не установлены): `pip install -r requirements.txt`.
3. Запустите административного бота: `python -m admin_bot`.

### Команды панели
- `/stats` — сводная статистика по пользователям (всего, активные, заблокированные).
- `/users [limit]` — последние зарегистрированные пользователи (до 100 записей).
- `/broadcast <текст>` — рассылка сообщения всем активным пользователям.
- `/ban <user_id>` — блокировка пользователя в панели.
- `/unban <user_id>` — снятие блокировки.

Все действия админов сохраняются в таблицу `admin_logs` и дублируются в файл `ADMIN_LOG_FILE`.

## Команды бота
При запуске скрипта список команд автоматически регистрируется через Bot API, поэтому настраивать их в BotFather не требуется. Доступные команды:

- `/start` — приветствие, обработка реферального кода и вывод главного меню.
- `/menu` — повторный вывод главного меню.
- `/persona` — выбор роли собеседника.
- `/session` — начало основной сессии общения.
- `/checkin` — быстрый чек-ин настроения.
- `/journal` — запуск окна для записи в дневник.
- `/tests` — запуск опросников PHQ-9 и GAD-7.
- `/resources` — выдача списка полезных ресурсов.
- `/meditation` — меню медитаций и управление аудиотреками.
- `/account` — информация о тарифах и оплате.
- `/invite` — получение персональной ссылки приглашения.
- `/referrals` — статистика по приглашённым пользователям и бонусам.

## Переменные окружения
- `TELEGRAM_BOT_TOKEN` — токен Telegram-бота, полученный у BotFather.
- `ADMIN_TELEGRAM_BOT_TOKEN` — отдельный токен административного бота, созданного через BotFather.
- `DEEPSEEK_API_KEY` — API-ключ DeepSeek для генерации ответов.
- `DEEPSEEK_BASE_URL`, `DEEPSEEK_MODEL` — параметры подключения к LLM (опционально).
- `DATABASE_URL` — строка подключения к базе данных (по умолчанию SQLite файл `aura.db` для бота и PostgreSQL для реферального сервиса).
- `CONVERSATION_HISTORY_LIMIT` — максимальное число реплик в истории диалога, которые сохраняются в таблице `conversation_messages`.
- `AUDIO_DIR` или `AUDIO_BASE_URL` — настройки источника аудио для медитаций.
- `REF_SALT`, `REF_BONUS_DAYS_JOINED`, `REF_BONUS_DAYS_PAID` — параметры реферальной программы бота.
- `MAX_REGISTRATIONS_PER_IP`, `REFERRAL_BASE_URL` — настройки backend-сервиса рефералов.
- `ADMIN_USER_IDS` — список ID администраторов административного бота.
- `ADMIN_DATABASE_PATH` — путь до SQLite-файла панели управления (опционально).
- `ADMIN_LOG_FILE` — путь к файлу логов административных действий (опционально).

### Как подготовить `.env`
1. Откройте файл `.env`, который лежит в репозитории, — в нём уже перечислены все ключевые параметры с пустыми значениями.
2. Заполните обязательные поля (`TELEGRAM_BOT_TOKEN`, `ADMIN_TELEGRAM_BOT_TOKEN`, `DEEPSEEK_API_KEY`, `DATABASE_URL`).
3. Если административный бот вам не нужен, оставьте `ADMIN_TELEGRAM_BOT_TOKEN` и `ADMIN_USER_IDS` пустыми — модуль просто не будет запускаться.
4. Остальные параметры настройте под свою инфраструктуру (база данных, директория медитаций, ключи LLM и т. д.).

> ℹ️ При необходимости вы можете создать собственные варианты файла, например `.env.local`, чтобы хранить разные наборы настроек для разработки и продакшена.

### Запуск в Windows без виртуального окружения

Если вы не хотите создавать отдельное виртуальное окружение, проект можно запустить прямо с системным Python:

1. Убедитесь, что в PATH есть установленный Python 3.11+ (команда `python --version` в PowerShell должна сработать).
2. Установите зависимости для текущего пользователя: `python -m pip install --user -r requirements.txt`.
3. Запустите бота напрямую: `python Aura_Psycholog_bot.py`.
4. Для запуска дополнительных сценариев ориентируйтесь на подсказки из `powershell_launch_guide.txt` или вызывайте нужные скрипты напрямую через `python <имя_файла>.py`.

> ℹ️ Создание виртуального окружения остаётся опциональным: если впоследствии захочется изолировать зависимости, выполните `python -m venv .venv` и активируйте его перед запуском. Без файла `.venv` проект продолжит работать.

### Главное меню бота
- Кнопка «🆘 Ресурсы»/«Ресурсы» отправляет подборку экстренных контактов и инструкций по безопасности.
- Кнопка «🧪 Шкалы»/«Шкалы» открывает выбор опросников PHQ-9 и GAD-7.
- Кнопка «💳 Подписка»/«Подписка» показывает тарифы с вариантами оплаты и условиями бонусов.

## Полезные материалы
- Подробное описание тарифов доступно в `tariff_ru.md`.

