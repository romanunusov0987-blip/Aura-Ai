# Aura-Ai

Aura — Telegram-бот онлайн-психолога с поддержкой медитаций, дневника и расширенной реферальной системы. Репозиторий содержит однофайловую версию бота и примеры backend-сервисов, которые обеспечивают платёжные и партнёрские сценарии.

## Структура проекта
- `aura_single_plus.py` — главный сценарий бота. Он подключается к Telegram, настраивает окружение и описывает, как бот ведёт диалог с пользователем.
- `db.py` — помощник для работы с базой данных. Здесь создаётся подключение и описаны общие функции для сохранения данных.
- `example.env` — образец файла настроек. По нему удобно собрать собственный `.env` с токенами и ключами.
- `.env` — личные секреты и настройки окружения (не хранится в репозитории, но упомянут для понимания структуры).
- `requirements.txt` — список библиотек, которые нужно установить перед запуском.
- `tariff_ru.md` — простое описание тарифов и услуг, доступных пользователю бота.
- `referral_app/` — отдельная папка с backend-сервисом FastAPI для реферальной программы.
  - `config.py` — хранит настройки бонусов, базовый URL для ссылок и лимиты по IP.
  - `database.py` — создаёт подключение к PostgreSQL и выдаёт сессии для работы с данными.
  - `models.py` — описывает таблицы в базе: пользователей, связи «кто кого пригласил» и журнал бонусов.
  - `schemas.py` — описывает структуру запросов и ответов API человеческим языком через Pydantic.
  - `crud.py` — бизнес-логика: генерация кодов, проверка регистраций, начисление и суммирование бонусных дней.
  - `main.py` — точка входа FastAPI, где собраны все REST-эндпоинты.
  - `__init__.py` — пустой файл, который показывает Python, что папка — модуль.
- `meditations/` — (необязательная) папка для собственных аудио-медитаций, если вы хотите хранить их локально.

### Что делает каждый файл (простыми словами)
- **`aura_single_plus.py`** — запускает бота и говорит ему, как отвечать людям.
- **`db.py`** — умеет подключаться к базе и сохранять туда информацию о пользователях и их действиях.
- **`referral_app/config.py`** — настройки реферальной программы: сколько дней даём в подарок и какие ограничения ставим.
- **`referral_app/database.py`** — создаёт соединение с базой данных для рефералок.
- **`referral_app/models.py`** — словарь таблиц в базе: кто пользователь, кто его пригласил, сколько бонусов начислено.
- **`referral_app/schemas.py`** — объясняет, какие поля ждём в запросах и что возвращаем в ответ.
- **`referral_app/crud.py`** — «мозг» сервиса: проверяет условия, считает бонусы и обновляет подписку.
- **`referral_app/main.py`** — связывает всё вместе и предоставляет HTTP-эндпоинты.
- **`README.md`** — это руководство по проекту: как устроено, как запускать и что где лежит.
- **`tariff_ru.md`** — текстовое описание тарифов, которое можно показать пользователю.
- **`requirements.txt`** — список зависимостей, который читают `pip` и другие менеджеры пакетов.
- **`example.env`** — подсказка, какие переменные окружения нужны для запуска.

### База данных и память диалогов бота
- Таблица `users` хранит Telegram ID, выбранную персону и базовую информацию о пользователе.
- Таблица `conversation_messages` сохраняет последние сообщения пользователя и ассистента для восстановления контекста общения (по умолчанию бот хранит 10 последних реплик, значение можно изменить переменной `CONVERSATION_HISTORY_LIMIT`).
- Таблицы `journal_entries`, `scale_results`, `event_logs`, `media_cache`, `referrals` и `user_bonuses` обслуживают дополнительные функции бота.

## Архитектура реферальной системы SaaS

### Обзор
Backend-реализация строится вокруг FastAPI и PostgreSQL. Сервис отвечает за генерацию реферальных ссылок, регистрацию по коду, учёт оплаченных подписок и автоматическое начисление бонусных дней пригласившему пользователю.

```
Клиент → FastAPI (referral_app/main.py) → SQLAlchemy (referral_app/database.py) → PostgreSQL
```

Основной сценарий:
1. Пользователь запрашивает уникальную ссылку (`POST /generate-referral-link`).
2. Приглашённый друг регистрируется по коду (`POST /register`).
3. Сервис фиксирует регистрацию, проверяет ограничение по IP и добавляет +3 дня пригласившему.
4. Когда приглашённый оплачивает подписку (`POST /subscribe`), рефереру начисляется ещё +7 дней.
5. Любой пользователь может посмотреть свою статистику (`GET /my-referrals`).

### Модели данных PostgreSQL
- `users`
  - `id` (UUID, PK)
  - `email` (уникальный), `name`, `password_hash`
  - `referral_code` (уникальный короткий код)
  - `referred_by_id` (FK → users.id) — кто пригласил
  - `subscription_end` (datetime) — окончание текущей подписки
  - `bonus_balance_days` (int) — суммарно начисленные бесплатные дни
  - `created_at` (datetime)
- `referrals`
  - `id` (UUID, PK)
  - `referrer_id`, `referee_id` (FK → users.id)
  - `registration_ip` (строка, используется для ограничения по IP)
  - `registered_at` (datetime)
  - `registration_bonus_days` (int, по умолчанию 3)
  - `subscription_bonus_awarded` (bool) и `subscription_bonus_days` (int, по умолчанию 0)
  - `subscription_awarded_at` (datetime) — когда бонус был начислен
- `bonus_events`
  - `id` (UUID, PK)
  - `user_id` (FK → users.id)
  - `referral_id` (FK → referrals.id)
  - `event_type` (`registration` или `subscription`)
  - `days_awarded`
  - `created_at`

Журнал `bonus_events` хранит полный след начислений и упрощает аудит или создание отчётов.

### Расчёт бонусных дней
- Регистрация по рефералу начисляет `settings.registration_bonus` (по умолчанию 3 дня) пригласившему.
- Первая оплата приглашённого пользователя начисляет `settings.subscription_bonus` (по умолчанию 7 дней).
- Функция `award_bonus_days` обновляет баланс пользователя и корректирует `subscription_end`: если подписка активна, дни прибавляются к текущей дате окончания, иначе отсчитываются от текущего момента.
- Ограничение по IP (`MAX_REGISTRATIONS_PER_IP`, по умолчанию 1) предотвращает злоупотребления множественными регистрациями.

### REST API
- `POST /generate-referral-link`
  - Тело: `{ "user_id": "UUID" }`
  - Результат: `{ "referral_code": "string", "referral_link": "https://..." }`
- `POST /register`
  - Тело: `{ "email": "user@example.com", "name": "Имя", "password": "***", "referral_code": "optional", "request_ip": "192.0.2.55" }`
  - Валидация: один IP не может зарегистрировать двух пользователей по одному и тому же коду.
  - Результат: `{ "user_id": "UUID", "awarded_days": 3, "referrer_id": "UUID" }`
- `POST /subscribe`
  - Тело: `{ "user_id": "UUID", "plan_days": 30 }`
  - Результат: `{ "user_id": "UUID", "subscription_end": "2024-05-01T12:00:00Z", "referrer_bonus_awarded": true, "referrer_id": "UUID" }`
- `GET /my-referrals`
  - Параметры: `?user_id=UUID`
  - Результат: список приглашённых и сводка начисленных дней.

### Запуск backend-сервиса рефералов
1. Настройте PostgreSQL и создайте базу данных `referral_db` (или укажите свою строку подключения в переменной `DATABASE_URL`).
2. Установите зависимости: `pip install -r requirements.txt`.
3. Запустите API: `uvicorn referral_app.main:app --reload`.
4. Документация будет доступна по адресу `http://127.0.0.1:8000/docs`.

## Быстрый старт Telegram-бота
1. Создайте и заполните файл `.env` по образцу `example.env` (значение `CONVERSATION_HISTORY_LIMIT` можно изменить прямо в файле, чтобы контролировать глубину памяти диалога).
2. Установите зависимости: `pip install -r requirements.txt`.
3. Запустите бота: `python aura_single_plus.py`.

## Команды бота
При запуске скрипта список команд автоматически регистрируется через Bot API, поэтому настраивать их в BotFather не требуется. Доступные команды:

- `/start` — приветствие, обработка реферального кода и вывод главного меню.
- `/menu` — повторный вывод главного меню.
- `/persona` — выбор роли собеседника.
- `/session` — начало основной сессии общения.
- `/checkin` — быстрый чек-ин настроения.
- `/journal` — запуск окна для записи в дневник.
- `/tests` — запуск опросников PHQ-9 и GAD-7.
- `/resources` — выдача списка полезных ресурсов.
- `/meditation` — меню медитаций и управление аудиотреками.
- `/account` — информация о тарифах и оплате.
- `/invite` — получение персональной ссылки приглашения.
- `/referrals` — статистика по приглашённым пользователям и бонусам.

## Переменные окружения
- `TELEGRAM_BOT_TOKEN` — токен Telegram-бота, полученный у BotFather.
- `DEEPSEEK_API_KEY` — API-ключ DeepSeek для генерации ответов.
- `DEEPSEEK_BASE_URL`, `DEEPSEEK_MODEL` — параметры подключения к LLM (опционально).
- `DATABASE_URL` — строка подключения к базе данных (по умолчанию SQLite файл `aura.db` для бота и PostgreSQL для реферального сервиса).
- `CONVERSATION_HISTORY_LIMIT` — максимальное число реплик в истории диалога, которые сохраняются в таблице `conversation_messages`.
- `AUDIO_DIR` или `AUDIO_BASE_URL` — настройки источника аудио для медитаций.
- `REF_SALT`, `REF_BONUS_DAYS_JOINED`, `REF_BONUS_DAYS_PAID` — параметры реферальной программы бота.
- `MAX_REGISTRATIONS_PER_IP`, `REFERRAL_BASE_URL` — настройки backend-сервиса рефералов.

### Главное меню бота
- Кнопка «🆘 Ресурсы»/«Ресурсы» отправляет подборку экстренных контактов и инструкций по безопасности.
- Кнопка «🧪 Шкалы»/«Шкалы» открывает выбор опросников PHQ-9 и GAD-7.
- Кнопка «💳 Подписка»/«Подписка» показывает тарифы с вариантами оплаты и условиями бонусов.

## Полезные материалы
- Подробное описание тарифов доступно в `tariff_ru.md`.

